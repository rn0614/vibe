# State Management Rules

## âš ï¸ ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ ìš°ì„  í™•ì¸

**ìƒíƒœ ê´€ë¦¬ ì½”ë“œ ì‘ì„± ì „ì— ë°˜ë“œì‹œ ì‹¤ì œ ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆë¥¼ í™•ì¸í•˜ì„¸ìš”:**

ğŸ“ **`front/src/shared/types/database.ts`**

```typescript
// âœ… ì˜¬ë°”ë¥¸ ë°©ë²•: ë¨¼ì € ìŠ¤í‚¤ë§ˆ í™•ì¸
import type { Tables, TablesInsert, TablesUpdate } from '@/shared/types/database';

// ì‹¤ì œ ìŠ¤í‚¤ë§ˆë¥¼ ê¸°ë°˜ìœ¼ë¡œ íƒ€ì… ì •ì˜
type User = Tables<'users'>;
type TodoItem = Tables<'tb_todolist'>;
type CreateTodo = TablesInsert<'tb_todolist'>;
type UpdateTodo = TablesUpdate<'tb_todolist'>;

// âŒ ì˜ëª»ëœ ë°©ë²•: ì¶”ì¸¡ìœ¼ë¡œ ì¸í„°í˜ì´ìŠ¤ ì •ì˜
interface Todo {
  id: number;
  text: string; // ì‹¤ì œë¡œëŠ” 'title' í•„ë“œì¼ ìˆ˜ ìˆìŒ!
}
```

## ğŸ—‘ï¸ Soft Delete ìƒíƒœ ê´€ë¦¬ (í•„ìˆ˜ ì¤€ìˆ˜)

**`deleted_at` í•„ë“œê°€ ìˆëŠ” í…Œì´ë¸”ì€ ë°˜ë“œì‹œ Soft Delete íŒ¨í„´ì„ ì ìš©í•˜ì„¸ìš”.**

### Query ì‘ì„± ì‹œ ê¸°ë³¸ íŒ¨í„´
```typescript
// âœ… ëª¨ë“  ì¡°íšŒ ì¿¼ë¦¬ì— deleted_at í•„í„° ì ìš©
const todosQuery = React.useMemo(() => {
  let query = createSupabaseQuery('tb_todolist')
    .select('*')
    .where('deleted_at', 'is', null); // í•„ìˆ˜!
  
  // ì¶”ê°€ í•„í„°ë§, ì •ë ¬, í˜ì´ì§€ë„¤ì´ì…˜ ë“±...
  return query;
}, [dependencies]);

// âŒ ì˜ëª»ëœ ë°©ë²•: deleted_at í•„í„° ëˆ„ë½
const badQuery = createSupabaseQuery('tb_todolist').select('*');
```

### Mutationì—ì„œ Soft Delete ì ìš©
```typescript
// âœ… Soft Delete: update ë®¤í…Œì´ì…˜ ì‚¬ìš©
const softDeleteTodo = (todoId: string) => {
  updateTodo.mutate({
    id: todoId,
    data: {
      deleted_at: new Date().toISOString(),
      updated_at: new Date().toISOString(),
    }
  });
};

// âŒ ì˜ëª»ëœ ë°©ë²•: delete ë®¤í…Œì´ì…˜ ì‚¬ìš©
const hardDeleteTodo = (todoId: string) => {
  deleteTodo.mutate({ id: todoId }); // ì‚¬ìš© ê¸ˆì§€!
};
```

### ìƒíƒœ í™•ì¸ ë¡œì§
```typescript
// âœ… ìˆ˜ì •/ì‚­ì œ ì „ deleted_at í™•ì¸
const handleEdit = (item: TodoItem) => {
  if (item.deleted_at !== null) {
    alert('ì‚­ì œëœ í•­ëª©ì€ ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }
  // ìˆ˜ì • ë¡œì§...
};

const handleDelete = (item: TodoItem) => {
  if (item.deleted_at !== null) {
    alert('ì´ë¯¸ ì‚­ì œëœ í•­ëª©ì…ë‹ˆë‹¤.');
    return;
  }
  // Soft Delete ë¡œì§...
};
```

## TanStack Query ì„¤ì •

### Query Client ê¸°ë³¸ ì„¤ì •
```typescript
// src/app/providers/query/QueryProvider.tsx
const createQueryClient = () => new QueryClient({
  defaultOptions: {
    queries: {
      staleTime: 5 * 60 * 1000,        // 5ë¶„ê°„ ìºì‹œ ìœ ì§€
      gcTime: 10 * 60 * 1000,          // 10ë¶„ê°„ ìºì‹œ ë³´ê´€
      retry: 1,                        // ì—ëŸ¬ ì‹œ ì¬ì‹œë„ 1íšŒ
      refetchOnWindowFocus: false,     // ìœˆë„ìš° í¬ì»¤ìŠ¤ ì‹œ ìë™ ë¦¬í˜ì¹˜ ë¹„í™œì„±í™”
      refetchOnReconnect: true,        // ë„¤íŠ¸ì›Œí¬ ì¬ì—°ê²° ì‹œ ìë™ ë¦¬í˜ì¹˜
    },
    mutations: {
      retry: false,                    // ë®¤í…Œì´ì…˜ ì—ëŸ¬ ì‹œ ì¬ì‹œë„ ì—†ìŒ
    },
  },
});
```

### DevTools ì„¤ì •
```typescript
export const QueryProvider: React.FC<QueryProviderProps> = ({ children }) => {
  const [queryClient] = useState(createQueryClient);

  return (
    <QueryClientProvider client={queryClient}>
      {children}
      {/* ê°œë°œ í™˜ê²½ì—ì„œë§Œ DevTools í‘œì‹œ */}
      {import.meta.env.DEV && (
        <ReactQueryDevtools 
          initialIsOpen={false}
          position="bottom"
        />
      )}
    </QueryClientProvider>
  );
};
```

## ì¿¼ë¦¬ í‚¤ ê´€ë¦¬ ì „ëµ

### í‘œì¤€í™”ëœ Query Key ìƒì„±
```typescript
export const createQueryKeys = (entity: string) => ({
  all: () => [entity] as const,
  lists: () => [...createQueryKeys(entity).all(), 'list'] as const,
  list: (filters: Record<string, unknown>) => 
    [...createQueryKeys(entity).lists(), filters] as const,
  details: () => [...createQueryKeys(entity).all(), 'detail'] as const,
  detail: (id: string) => [...createQueryKeys(entity).details(), id] as const,
});

// ê³µí†µ Query Keys ì •ì˜
export const QUERY_KEYS = {
  users: createQueryKeys('users'),
  todos: createQueryKeys('todos'),
  posts: createQueryKeys('posts'),
} as const;
```

### Query Key ì‚¬ìš© íŒ¨í„´
```typescript
// âœ… ê¶Œì¥ ì‚¬ìš©ë²•
const userKeys = QUERY_KEYS.users;

// ëª¨ë“  ì‚¬ìš©ì ì¿¼ë¦¬ ë¬´íš¨í™”
queryClient.invalidateQueries({ queryKey: userKeys.all() });

// íŠ¹ì • ì‚¬ìš©ì ìƒì„¸ ì •ë³´ ë¬´íš¨í™”
queryClient.invalidateQueries({ queryKey: userKeys.detail('123') });
```

## Supabase Query Builder íŒ¨í„´

### ê¸°ë³¸ ì‚¬ìš©ë²•
```typescript
// ì²´ì´ë‹ ê°€ëŠ¥í•œ ì¿¼ë¦¬ ë¹Œë”
const usersQuery = createSupabaseQuery('users')
  .select('id, name, email, avatar_url')
  .where('status', 'eq', 'active')
  .search(['name', 'email'], searchTerm)
  .paginate({ page: 0, size: 20 })
  .sort('created_at', 'desc');

// TanStack Queryì™€ í†µí•©
const { data: users, isLoading } = useSupabaseQueryBuilder(usersQuery, {
  enabled: !!searchTerm,
  staleTime: 2 * 60 * 1000,
});
```

### íƒ€ì… ì•ˆì „í•œ ë©”ì„œë“œ
```typescript
// íƒ€ì… ì•ˆì „í•œ ì¿¼ë¦¬ ë¹Œë” ì‚¬ìš©
const todosQuery = createSupabaseQuery('tb_todolist')
  .selectColumns(['id', 'created_at'])              // íƒ€ì… ì•ˆì „í•œ ì»¬ëŸ¼ ì„ íƒ
  .whereEq('user_id', currentUser.id)               // íƒ€ì… ì•ˆì „í•œ ì¡°ê±´
  .searchInColumn('title', searchTerm)              // ë‹¨ì¼ ì»¬ëŸ¼ ê²€ìƒ‰
  .orderByDesc('created_at')                        // ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
  .withCount();                                     // ë°ì´í„°ì™€ ì¹´ìš´íŠ¸ í•¨ê»˜ ì¡°íšŒ

const { data: result } = useSupabaseQueryBuilder(todosQuery);
// result: { data: TodoItem[], totalCount: number }
```

## ë®¤í…Œì´ì…˜ íŒ¨í„´

### CRUD ë®¤í…Œì´ì…˜
```typescript
// ê¸°ë³¸ ë®¤í…Œì´ì…˜ ì„¤ì •
const createTodo = useSupabaseMutationBuilder('tb_todolist', 'insert', {
  invalidateQueries: ['tb_todolist'],
  onSuccess: (newTodo) => {
    console.log('Todo ìƒì„±ë¨:', newTodo);
  },
  onError: (error) => {
    console.error('Todo ìƒì„± ì‹¤íŒ¨:', error);
  }
});

const updateTodo = useSupabaseMutationBuilder('tb_todolist', 'update', {
  invalidateQueries: ['tb_todolist']
});

const deleteTodo = useSupabaseMutationBuilder('tb_todolist', 'delete', {
  invalidateQueries: ['tb_todolist']
});

// ì‚¬ìš©ë²•
createTodo.mutate({ data: { title: 'New Todo', user_id: userId } });
updateTodo.mutate({ id: todoId, data: { completed: true } });
deleteTodo.mutate({ id: todoId });
```

### ì˜µí‹°ë¯¸ìŠ¤í‹± ì—…ë°ì´íŠ¸
```typescript
const useOptimisticTodoUpdate = () => {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: async ({ id, data }: { id: string; data: Partial<TodoItem> }) => {
      const { data: updated, error } = await supabase
        .from('tb_todolist')
        .update(data)
        .eq('id', id)
        .select()
        .single();

      if (error) throw error;
      return updated;
    },
    
    onMutate: async ({ id, data }) => {
      // ì§„í–‰ ì¤‘ì¸ ì¿¼ë¦¬ ì·¨ì†Œ
      await queryClient.cancelQueries({ queryKey: QUERY_KEYS.todos.all() });

      // ì´ì „ ë°ì´í„° ë°±ì—…
      const previousTodos = queryClient.getQueryData(QUERY_KEYS.todos.list({}));

      // ë‚™ê´€ì  ì—…ë°ì´íŠ¸
      queryClient.setQueryData(QUERY_KEYS.todos.list({}), (old: TodoItem[]) =>
        old?.map(todo => todo.id === id ? { ...todo, ...data } : todo)
      );

      return { previousTodos };
    },
    
    onError: (err, variables, context) => {
      // ì—ëŸ¬ ì‹œ ì´ì „ ë°ì´í„°ë¡œ ë¡¤ë°±
      if (context?.previousTodos) {
        queryClient.setQueryData(QUERY_KEYS.todos.list({}), context.previousTodos);
      }
    },
    
    onSettled: () => {
      // ì™„ë£Œ í›„ ë°ì´í„° ìƒˆë¡œê³ ì¹¨
      queryClient.invalidateQueries({ queryKey: QUERY_KEYS.todos.all() });
    },
  });
};
```

## ì»¤ìŠ¤í…€ í›… ê°€ì´ë“œ

### ë„¤ì´ë° ì»¨ë²¤ì…˜
```typescript
// âœ… ê¶Œì¥ ë„¤ì´ë°
use{Domain}{Action}        // useAuthSignIn, useUserCreate
use{Domain}{Entity}        // useAuthUser, useUserProfile
use{Domain}{State}         // useAuthState, useThemeState

// âŒ ë¹„ê¶Œì¥
useAuth                    // ë„ˆë¬´ ëª¨í˜¸í•¨
useGetUser                 // ë¶ˆí•„ìš”í•œ Get ì ‘ë‘ì‚¬
useUserData                // Data ì ‘ë¯¸ì‚¬ëŠ” ë¶ˆí•„ìš”
```

### ë„ë©”ì¸ë³„ í›… êµ¬ì¡°
```typescript
// src/domains/auth/hooks/useAuth.ts
export const useAuth = () => {
  // TanStack Queryë¥¼ í™œìš©í•œ ì‚¬ìš©ì ìƒíƒœ ê´€ë¦¬
  const userQuery = useQuery({
    queryKey: AUTH_USER_QUERY_KEY,
    queryFn: async (): Promise<User | null> => {
      try {
        const response = await authApi.getCurrentUser();
        return response.data.data.user;
      } catch {
        return null;
      }
    },
    staleTime: 5 * 60 * 1000,
    retry: (failureCount, error: ApiException) => {
      if (error?.status === 401 || error?.status === 403) {
        return false;
      }
      return failureCount < 2;
    },
  });

  // ë®¤í…Œì´ì…˜ë“¤
  const signOutMutation = useMutation({ /* ... */ });

  return {
    // ìƒíƒœ
    user: userQuery.data ?? null,
    isLoading: userQuery.isLoading,
    isAuthenticated: !!userQuery.data,
    
    // ì•¡ì…˜
    signOut: signOutMutation.mutate,
    
    // ë¡œë”© ìƒíƒœ
    isActionLoading: signOutMutation.isPending,
  };
};
```

### ì•¡ì…˜ ë¶„ë¦¬ íŒ¨í„´
```typescript
// src/domains/auth/hooks/useAuthActions.ts
export const useAuthActions = () => {
  const navigate = useNavigate();
  const auth = useAuth();

  const signOutWithRedirect = async (redirectTo = "/") => {
    await auth.signOutAsync();
    navigate(redirectTo, { replace: true });
  };

  return {
    ...auth,                    // ê¸°ë³¸ auth ê¸°ëŠ¥ ìƒì†
    signOutWithRedirect,        // navigation í¬í•¨ ì•¡ì…˜
  };
};
```

## ì„œë²„ ìƒíƒœ vs í´ë¼ì´ì–¸íŠ¸ ìƒíƒœ

### ì„œë²„ ìƒíƒœ (TanStack Query)
```typescript
// âœ… ì„œë²„ì—ì„œ ê°€ì ¸ì˜¤ëŠ” ë°ì´í„°
// - ì‚¬ìš©ì ì •ë³´, Todo ëª©ë¡, ê²Œì‹œê¸€ ëª©ë¡, ì„œë²„ ì„¤ì •

const { data: user } = useAuth();
const { data: todos } = useSupabaseQueryBuilder(todosQuery);
```

### í´ë¼ì´ì–¸íŠ¸ ìƒíƒœ (React State)
```typescript
// âœ… í´ë¼ì´ì–¸íŠ¸ì—ì„œë§Œ ì‚¬ìš©í•˜ëŠ” ìƒíƒœ
// - UI í…Œë§ˆ, ëª¨ë‹¬ ìƒíƒœ, í¼ ì…ë ¥, ë¡œì»¬ í•„í„°

const [isModalOpen, setIsModalOpen] = useState(false);
const [searchTerm, setSearchTerm] = useState('');
const { theme, setTheme } = useTheme();
```

### Zustand ìŠ¤í† ì–´ íŒ¨í„´ (í•„ìš”ì‹œ)
```typescript
// src/app/store/uiStore.ts
import { create } from 'zustand';

interface UIState {
  isLoadingGlobal: boolean;
  modalStack: string[];
  setGlobalLoading: (isLoading: boolean) => void;
  pushModal: (modalId: string) => void;
  popModal: () => void;
}

export const useUIStore = create<UIState>((set) => ({
  isLoadingGlobal: false,
  modalStack: [],
  
  setGlobalLoading: (isLoading) => set({ isLoadingGlobal: isLoading }),
  
  pushModal: (modalId) => set((state) => ({
    modalStack: [...state.modalStack, modalId]
  })),
  
  popModal: () => set((state) => ({
    modalStack: state.modalStack.slice(0, -1)
  })),
}));
```

## ìºì‹œ ë¬´íš¨í™” íŒ¨í„´

### Query ë¬´íš¨í™” ìœ í‹¸ë¦¬í‹°
```typescript
export const useInvalidateQueries = () => {
  const queryClient = useQueryClient();

  return {
    invalidateEntity: (entity: keyof typeof QUERY_KEYS) => {
      queryClient.invalidateQueries({ queryKey: QUERY_KEYS[entity].all() });
    },
    
    invalidateEntityDetail: (entity: keyof typeof QUERY_KEYS, id: string) => {
      queryClient.invalidateQueries({ queryKey: QUERY_KEYS[entity].detail(id) });
    },
  };
};
```

### ì‹¤ì‹œê°„ êµ¬ë…ê³¼ ìºì‹œ ë™ê¸°í™”
```typescript
export const useRealtimeSync = (table: string, userId?: string) => {
  const queryClient = useQueryClient();

  useEffect(() => {
    if (!userId) return;

    const subscription = supabase
      .channel(`${table}-changes`)
      .on('postgres_changes', {
        event: '*',
        schema: 'public',
        table,
        filter: `user_id=eq.${userId}`
      }, (payload) => {
        switch (payload.eventType) {
          case 'INSERT':
          case 'UPDATE':
            queryClient.invalidateQueries({ queryKey: [table] });
            break;
          case 'DELETE':
            queryClient.removeQueries({ 
              queryKey: [table, { type: 'detail', id: payload.old.id }] 
            });
            break;
        }
      })
      .subscribe();

    return () => subscription.unsubscribe();
  }, [table, userId, queryClient]);
};
```

## ì—ëŸ¬ ë° ë¡œë”© ìƒíƒœ ì²˜ë¦¬

### ê¸€ë¡œë²Œ ì—ëŸ¬ ì²˜ë¦¬
```typescript
const createQueryClient = () => new QueryClient({
  defaultOptions: {
    queries: {
      onError: (error: ApiException) => {
        if (error?.status === 401) {
          // ìë™ ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
        }
        console.error('Query error:', error);
      },
    },
  },
});
```

### ë¡œë”© ìƒíƒœ ì¡°í•©
```typescript
export const useGlobalLoadingState = () => {
  const { isFetching } = useIsFetching();
  const { isPending } = useIsMutating();

  return {
    isLoading: isFetching > 0 || isPending > 0,
    isQueryLoading: isFetching > 0,
    isMutationLoading: isPending > 0,
  };
};
```